#!/usr/bin/env bash
# shellcheck disable=SC2154
# 0-custom_http_response_header
# Configure a fresh Ubuntu machine to add a custom response header:
# X-Served-By: <hostname>

set -euo pipefail

# update and install nginx if needed
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y nginx

# ensure we have a hostname set (script trusts the system hostname)
HOSTNAME="$(hostname -s)"

# location of the site config for default Ubuntu nginx
NGINX_DEFAULT_CONF="/etc/nginx/sites-available/default"

# backup existing config
if [ ! -f "${NGINX_DEFAULT_CONF}.orig" ]; then
  cp -a "$NGINX_DEFAULT_CONF" "${NGINX_DEFAULT_CONF}.orig"
fi

# Insert/add the header inside the server block.
# If an X-Served-By already exists, replace it. Otherwise add it right after 'listen' or at top of server block.
# Use a temp file for safe editing.
tmpfile="$(mktemp)"
awk -v hdr="add_header X-Served-By \$hostname;" '
  BEGIN{inside_server=0; done_hdr=0}
  {
    print $0
    # Detect start of server block
    if ($0 ~ /^[[:space:]]*server[[:space:]]*\{[[:space:]]*$/) {
      inside_server=1
      next
    }
    if (inside_server) {
      # If header already present, replace it
      if ($0 ~ /add_header[[:space:]]+X-Served-By/) {
        # replace current line with our header (ensures consistent formatting)
        sub(/.*/, "    " hdr)
        print ""
        done_hdr=1
        next
      }
      # Insert header after first 'listen' or 'server_name' or first non-empty directive inside server
      if (!done_hdr && $0 ~ /listen[[:space:]]+/) {
        print "    " hdr
        done_hdr=1
      }
    }
    # Detect closing of server block
    if (inside_server && $0 ~ /^[[:space:]]*\}[[:space:]]*$/) {
      inside_server=0
      if (!done_hdr) {
        # header not added inside server block yet => inject just before closing brace
        sub(/^[[:space:]]*\}[[:space:]]*$/, "    " hdr "\n}")
        done_hdr=1
      }
    }
  }
' "$NGINX_DEFAULT_CONF" > "$tmpfile"

# move back
mv "$tmpfile" "$NGINX_DEFAULT_CONF"
chmod 644 "$NGINX_DEFAULT_CONF"

# test nginx config and reload
nginx -t
systemctl restart nginx

# Optional: open firewall for HTTP (safe if using ufw)
if command -v ufw >/dev/null 2>&1; then
  # allow 'Nginx HTTP' profile if not already allowed
  if ! ufw status | grep -q "Nginx HTTP"; then
    ufw allow 'Nginx HTTP' || true
  fi
fi

# final sanity: show a short curl check (server must be reachable locally)
echo "Sanity check (local):"
curl -sI http://127.0.0.1 | grep -i X-Served-By || echo "Header not present in local check â€” check nginx config"
echo "Configured X-Served-By to use system hostname: ${HOSTNAME}"
