#!/usr/bin/env bash
# Install and configure HAProxy load balancer on Ubuntu

set -e

# Your real server IPs
WEB01_IP="34.203.249.38"
WEB02_IP="3.82.148.239"

echo "Updating package list..."
apt-get update -y

echo "Installing HAProxy..."
apt-get install -y haproxy

echo "Adding hostnames to /etc/hosts..."
cat <<EOF >> /etc/hosts
${WEB01_IP} web-01
${WEB02_IP} web-02
EOF

echo "Enabling HAProxy via init script..."
sed -i 's/ENABLED=0/ENABLED=1/' /etc/default/haproxy

echo "Configuring HAProxy..."
cat <<EOF > /etc/haproxy/haproxy.cfg
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    user haproxy
    group haproxy

defaults
    mode http
    option httplog
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    server web01 web-01:80 check
    server web02 web-02:80 check
EOF

echo "Restarting HAProxy..."
service haproxy restart

echo "HAProxy setup completed successfully!"
